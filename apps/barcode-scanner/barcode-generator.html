<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Barcode Generator | Zipybills</title>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 1rem;
      color: #1a1a2e;
    }
    h1 { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.25rem; }
    .subtitle { color: #6b7280; font-size: 0.95rem; margin-bottom: 0.5rem; }
    .machine-badge { display: inline-flex; align-items: center; gap: 0.4rem; background: #eef2ff; border: 1px solid #c7d2fe; border-radius: 8px; padding: 0.35rem 0.75rem; font-size: 0.8rem; font-weight: 600; color: #4f46e5; margin-bottom: 0.75rem; }
    .flow-diagram { background: #fefce8; border: 1px solid #fde68a; border-radius: 10px; padding: 0.75rem 1rem; font-size: 0.8rem; color: #92400e; text-align: center; margin-bottom: 1rem; max-width: 500px; width: 100%; }
    .flow-steps { display: flex; align-items: center; justify-content: center; gap: 0.25rem; margin-top: 0.5rem; font-weight: 600; flex-wrap: wrap; }
    .flow-step { padding: 0.2rem 0.5rem; border-radius: 6px; font-size: 0.75rem; }
    .flow-step.active { background: #4f46e5; color: #fff; }
    .flow-step.pending { background: #e5e7eb; color: #6b7280; }
    .flow-arrow { color: #9ca3af; font-size: 0.7rem; }
    .status-bar {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      font-size: 0.8rem;
    }
    .status-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: #ef4444;
    }
    .status-dot.connected { background: #22c55e; }
    .status-text { color: #6b7280; }
    .card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 16px rgba(0,0,0,0.04);
      padding: 2rem;
      width: 100%;
      max-width: 500px;
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .barcode-area {
      background: #fff;
      border: 2px dashed #e5e7eb;
      border-radius: 12px;
      padding: 1.5rem 1rem;
      margin-bottom: 1.5rem;
      min-height: 160px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .barcode-area.has-barcode { border: 2px solid #e5e7eb; }
    #barcode-svg { max-width: 100%; }
    .barcode-value {
      margin-top: 0.75rem;
      font-size: 1.25rem;
      font-weight: 700;
      font-family: 'SF Mono', 'Fira Code', monospace;
      color: #1a1a2e;
      letter-spacing: 2px;
    }
    .barcode-meta {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 0.25rem;
    }
    .placeholder-text { color: #9ca3af; font-size: 0.95rem; }
    .controls { display: flex; flex-direction: column; gap: 0.75rem; }
    .btn {
      padding: 0.85rem 1.5rem;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: #6366f1; color: #fff; }
    .btn-primary:hover:not(:disabled) { background: #4f46e5; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(99,102,241,0.3); }
    .btn-secondary { background: #f3f4f6; color: #374151; }
    .btn-secondary:hover:not(:disabled) { background: #e5e7eb; }
    .btn-green { background: #10b981; color: #fff; }
    .btn-green:hover:not(:disabled) { background: #059669; transform: translateY(-1px); }
    .info-box {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      border-radius: 10px;
      padding: 0.75rem 1rem;
      font-size: 0.85rem;
      color: #1e40af;
      text-align: left;
      margin-bottom: 1rem;
    }
    .history { width: 100%; max-width: 500px; }
    .history h3 { font-size: 1rem; font-weight: 600; margin-bottom: 0.75rem; color: #374151; }
    .history-list { display: flex; flex-direction: column; gap: 0.5rem; }
    .history-item {
      background: #fff;
      border-radius: 10px;
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border: 1px solid #f3f4f6;
      cursor: pointer;
      transition: border-color 0.2s;
    }
    .history-item:hover { border-color: #6366f1; }
    .history-item .code {
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-weight: 600;
      font-size: 0.9rem;
      color: #1a1a2e;
    }
    .history-item .meta { font-size: 0.75rem; color: #9ca3af; }
    .history-item .badge {
      font-size: 0.7rem;
      padding: 0.15rem 0.5rem;
      border-radius: 6px;
      font-weight: 500;
    }
    .badge-api { background: #d1fae5; color: #065f46; }
    .badge-local { background: #eef2ff; color: #6366f1; }
    .counter { font-size: 0.8rem; color: #9ca3af; margin-top: 1rem; }
    .error-msg { color: #dc2626; font-size: 0.85rem; margin-top: 0.5rem; }
    .mode-toggle { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
    .mode-btn {
      flex: 1;
      padding: 0.6rem;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      background: #fff;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      color: #6b7280;
      transition: all 0.2s;
    }
    .mode-btn.active { border-color: #6366f1; background: #eef2ff; color: #6366f1; }
  </style>
</head>
<body>
  <div class="machine-badge" id="machine-badge">üè≠ Loading generator machine...</div>
  <h1>üìä Barcode Generator</h1>
  <p class="subtitle" id="subtitle">Loading machine configuration...</p>

  <div class="flow-diagram" id="flow-diagram">
    <strong>Factory Flow:</strong> Loading machines...
    <div class="flow-steps" id="flow-steps"></div>
  </div>

  <div class="status-bar">
    <div class="status-dot" id="status-dot"></div>
    <span class="status-text" id="status-text">Checking backend...</span>
  </div>

  <div class="card">
    <!-- Mode Toggle -->
    <div class="mode-toggle">
      <button class="mode-btn active" id="mode-api" onclick="setMode('api')">üîó Backend (DB)</button>
      <button class="mode-btn" id="mode-local" onclick="setMode('local')">üíª Local Only</button>
    </div>

    <div class="info-box" id="info-box">
      <strong>Backend Mode:</strong> Barcodes are generated by the generator machine and saved to SQL Server.<br/>
      Each barcode creates: <strong>barcodes</strong> table entry + <strong>machine_data</strong> entry for the generator machine.<br/>
      Employees then open the mobile app, choose their assigned machine, and scan to continue processing.
    </div>

    <!-- Barcode Display -->
    <div class="barcode-area" id="barcode-area">
      <p class="placeholder-text" id="placeholder">Click "Generate" to create a barcode</p>
      <svg id="barcode-svg" style="display:none;"></svg>
      <div class="barcode-value" id="barcode-value" style="display:none;"></div>
      <div class="barcode-meta" id="barcode-meta" style="display:none;"></div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <button class="btn btn-primary" id="btn-generate" onclick="generateBarcode()">
        üè≠ Generate Barcode
      </button>
      <button class="btn btn-secondary" onclick="clearHistory()">
        üóëÔ∏è Clear History
      </button>
    </div>

    <p class="counter" id="counter">0 barcodes generated this session</p>
    <p class="error-msg" id="error-msg" style="display:none;"></p>
  </div>

  <!-- History -->
  <div class="history">
    <h3>üìú Generated History <small style="font-weight:400;color:#9ca3af;">(click to display)</small></h3>
    <div class="history-list" id="history-list">
      <p class="placeholder-text" style="text-align:center;padding:1rem;">No barcodes generated yet</p>
    </div>
  </div>

  <script>
    const SCANNING_API = 'http://localhost:3003';
    const MACHINES_API = 'http://localhost:3006';
    let mode = 'api'; // 'api' or 'local'
    let count = 0;
    const history = [];
    let backendConnected = false;
    let generatorMachine = null; // The machine with can_generate_barcode
    let allMachines = [];        // All active machines

    // ‚îÄ‚îÄ‚îÄ Fetch machines & find generator ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadMachines() {
      try {
        const res = await fetch(`${MACHINES_API}/api/machines`, { signal: AbortSignal.timeout(3000) });
        const data = await res.json();
        if (data.success && data.machines) {
          allMachines = data.machines
            .filter(m => m.is_active)
            .sort((a, b) => a.sequence_order - b.sequence_order);
          generatorMachine = allMachines.find(m => m.can_generate_barcode) || null;
        }
      } catch {
        allMachines = [];
        generatorMachine = null;
      }
      updateMachineUI();
    }

    function updateMachineUI() {
      const badge = document.getElementById('machine-badge');
      const subtitle = document.getElementById('subtitle');
      const flowDiagram = document.getElementById('flow-diagram');
      const flowSteps = document.getElementById('flow-steps');
      const btn = document.getElementById('btn-generate');
      const infoBox = document.getElementById('info-box');

      if (generatorMachine) {
        badge.textContent = `üè≠ ${generatorMachine.machine_name} ‚Äî Generator Station`;
        subtitle.textContent = `${generatorMachine.machine_name} generates barcodes for the production line`;
        btn.textContent = `üè≠ Generate Barcode (${generatorMachine.machine_code})`;
        btn.disabled = false;

        // Build flow diagram dynamically
        const scanners = allMachines.filter(m => !m.can_generate_barcode);
        const scannerText = scanners.map(m => m.machine_code).join(', ');
        flowDiagram.innerHTML = `<strong>Factory Flow:</strong> ${generatorMachine.machine_code} generates a barcode ‚Üí Employees at ${scannerText} scan &amp; process sequentially`;

        let stepsHTML = `<span class="flow-step active">üè≠ ${generatorMachine.machine_code} Generate</span>`;
        scanners.forEach(m => {
          stepsHTML += `<span class="flow-arrow">‚Üí</span><span class="flow-step pending">üì± ${m.machine_code} Scan</span>`;
        });
        flowDiagram.innerHTML += `<div class="flow-steps">${stepsHTML}</div>`;

        if (mode === 'api') {
          infoBox.innerHTML = `<strong>Backend Mode (${generatorMachine.machine_name}):</strong> Barcodes are generated by ${generatorMachine.machine_code} and saved to SQL Server.<br/>Each barcode creates: <strong>barcodes</strong> table entry + <strong>machine_data</strong> entry for ${generatorMachine.machine_code}.<br/>Employees then open the mobile app, choose their machine, and scan to continue processing.`;
        }
      } else if (allMachines.length > 0) {
        badge.textContent = '‚ö†Ô∏è No generator machine found';
        subtitle.textContent = 'Go to the Machines page and set one machine with "Can Generate Barcodes" enabled';
        btn.textContent = '‚ö†Ô∏è No generator machine configured';
        btn.disabled = true;
        flowDiagram.innerHTML = '<strong>‚ö†Ô∏è No generator machine configured.</strong> Add a machine with the "Can Generate Barcodes" flag in the Machines page.';
      } else {
        badge.textContent = '‚ö†Ô∏è No machines configured';
        subtitle.textContent = 'Add machines in the Machines page first (at least one must be a generator)';
        btn.textContent = '‚ö†Ô∏è No machines ‚Äî add them in the app first';
        btn.disabled = true;
        flowDiagram.innerHTML = '<strong>‚ö†Ô∏è No machines found.</strong> Open the mobile app ‚Üí Machines page ‚Üí Add your machines. Make sure one has "Can Generate Barcodes" enabled.';
      }
    }

    // ‚îÄ‚îÄ‚îÄ Health Check ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function checkBackend() {
      try {
        const res = await fetch(`${SCANNING_API}/health`, { signal: AbortSignal.timeout(3000) });
        const data = await res.json();
        backendConnected = data.status === 'ok';
      } catch {
        backendConnected = false;
      }
      updateStatus();
      // Also refresh machines each time
      await loadMachines();
    }

    function updateStatus() {
      const dot = document.getElementById('status-dot');
      const text = document.getElementById('status-text');
      if (backendConnected) {
        dot.classList.add('connected');
        text.textContent = 'Backend connected (port 3003)';
      } else {
        dot.classList.remove('connected');
        text.textContent = 'Backend offline ‚Äî switch to Local mode';
        if (mode === 'api') {
          setMode('local');
        }
      }
    }

    function setMode(newMode) {
      mode = newMode;
      document.getElementById('mode-api').classList.toggle('active', mode === 'api');
      document.getElementById('mode-local').classList.toggle('active', mode === 'local');
      
      const info = document.getElementById('info-box');
      if (mode === 'api' && generatorMachine) {
        info.innerHTML = `<strong>Backend Mode (${generatorMachine.machine_name}):</strong> Barcodes are generated by ${generatorMachine.machine_code} and saved to SQL Server.<br/>Each barcode creates: <strong>barcodes</strong> table entry + <strong>machine_data</strong> entry for ${generatorMachine.machine_code}.<br/>Employees then open the mobile app, choose their machine, and scan to continue processing.`;
      } else if (mode === 'api') {
        info.innerHTML = '<strong>Backend Mode:</strong> No generator machine configured. Go to the Machines page first.';
      } else {
        info.innerHTML = '<strong>Local Mode:</strong> Barcodes are generated client-side only. They will NOT exist in your database. Use this mode if the backend is not running ‚Äî but note that scanning these from your phone will return "Barcode not found."';
      }
      hideError();
    }

    // ‚îÄ‚îÄ‚îÄ Generate Barcode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function generateBarcode() {
      const btn = document.getElementById('btn-generate');
      btn.disabled = true;
      btn.textContent = '‚è≥ Generating...';
      hideError();

      let barcodeValue = '';
      let source = '';

      try {
        if (mode === 'api') {
          if (!generatorMachine) {
            throw new Error('No generator machine configured. Add one in the Machines page.');
          }
          // Call the actual backend with the generator machine's ID
          const res = await fetch(`${SCANNING_API}/api/barcode/generate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ machineId: generatorMachine.machine_id }),
          });
          const data = await res.json();
          if (!data.success) throw new Error(data.error || 'API error');
          barcodeValue = data.barcode;
          source = 'api';
        } else {
          // Generate locally
          const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
          let s = 'ZB-';
          for (let i = 0; i < 10; i++) s += chars[Math.floor(Math.random() * chars.length)];
          barcodeValue = s;
          source = 'local';
        }

        displayBarcode(barcodeValue, source);
        
        count++;
        history.unshift({ value: barcodeValue, source, time: new Date().toLocaleTimeString() });
        document.getElementById('counter').textContent = count + ' barcode' + (count > 1 ? 's' : '') + ' generated this session';
        renderHistory();

      } catch (err) {
        showError(err.message + '. Try switching to Local mode.');
      } finally {
        btn.disabled = false;
        const machineLabel = generatorMachine ? generatorMachine.machine_code : '';
        btn.textContent = machineLabel ? `üè≠ Generate Barcode (${machineLabel})` : 'üè≠ Generate Barcode';
      }
    }

    function displayBarcode(value, source) {
      const svg = document.getElementById('barcode-svg');
      svg.style.display = 'block';
      document.getElementById('placeholder').style.display = 'none';
      document.getElementById('barcode-area').classList.add('has-barcode');

      JsBarcode(svg, value, {
        format: 'CODE128',
        width: 2,
        height: 80,
        displayValue: false,
        margin: 10,
        background: '#ffffff',
      });

      const valEl = document.getElementById('barcode-value');
      valEl.textContent = value;
      valEl.style.display = 'block';

      const meta = document.getElementById('barcode-meta');
      const machineTag = generatorMachine ? generatorMachine.machine_code : 'Generator';
      meta.textContent = source === 'api' 
        ? `CODE128 ‚Ä¢ ${machineTag} ‚úÖ ‚Ä¢ Saved to database` 
        : 'CODE128 ‚Ä¢ Local only (not in DB)';
      meta.style.display = 'block';
    }

    function renderHistory() {
      const list = document.getElementById('history-list');
      if (history.length === 0) {
        list.innerHTML = '<p class="placeholder-text" style="text-align:center;padding:1rem;">No barcodes generated yet</p>';
        return;
      }
      list.innerHTML = history.map((item, i) => `
        <div class="history-item" onclick="displayBarcode('${item.value}', '${item.source}')" title="Click to display">
          <div>
            <div class="code">${item.value}</div>
            <div class="meta">${item.time}</div>
          </div>
          <span class="badge ${item.source === 'api' ? 'badge-api' : 'badge-local'}">
            ${item.source === 'api' ? 'üè≠ ' + (generatorMachine ? generatorMachine.machine_code : 'GEN') + ' ‚úÖ' : 'üíª Local'}
          </span>
        </div>
      `).join('');
    }

    function clearHistory() {
      history.length = 0;
      count = 0;
      document.getElementById('counter').textContent = '0 barcodes generated this session';
      document.getElementById('barcode-svg').style.display = 'none';
      document.getElementById('barcode-value').style.display = 'none';
      document.getElementById('barcode-meta').style.display = 'none';
      document.getElementById('placeholder').style.display = 'block';
      document.getElementById('barcode-area').classList.remove('has-barcode');
      renderHistory();
    }

    function showError(msg) {
      const el = document.getElementById('error-msg');
      el.textContent = '‚ùå ' + msg;
      el.style.display = 'block';
    }
    function hideError() {
      document.getElementById('error-msg').style.display = 'none';
    }

    // Init
    checkBackend();
    setInterval(checkBackend, 10000); // Re-check every 10s
  </script>
</body>
</html>
